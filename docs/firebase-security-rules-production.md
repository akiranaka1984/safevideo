# Firebase セキュリティルール - 本番環境実装ガイド

## 概要

本ドキュメントは、SafeVideo KYCシステムの本番環境向けFirebaseセキュリティルールの実装詳細を説明します。

## セキュリティルールの構成

### 1. Firestore セキュリティルール

#### 主な機能強化：

- **多層的な権限管理**
  - 一般ユーザー
  - モデレーター
  - 管理者
  - スーパー管理者

- **アカウント状態の検証**
  - アクティブ状態の確認
  - 停止/禁止アカウントのアクセス制限

- **レート制限**
  - コレクション別の書き込み制限
  - 時間単位での制御

- **データ検証**
  - 必須フィールドの確認
  - データ型の検証
  - 正規表現によるフォーマット確認

#### 重要なコレクション：

1. **users** - ユーザープロフィール
2. **performers** - パフォーマー情報
3. **kycRequests** - KYC申請
4. **kycDocuments** - KYC書類
5. **videos** - 動画コンテンツ
6. **auditLogs** - 監査ログ（読み取り専用）

### 2. Cloud Storage セキュリティルール

#### ファイルタイプ別の制限：

- **KYC書類**: JPEG, PNG, WebP, PDF（最大10MB）
- **プロフィール画像**: JPEG, PNG, WebP, GIF（最大5MB）
- **動画コンテンツ**: MP4, WebM, OGG, MOV（最大500MB）
- **サムネイル**: 画像ファイル（最大2MB）

#### パス構造：

```
/kyc-documents/{userId}/{documentType}/{fileName}
/performer-profiles/{performerId}/avatar/{fileName}
/videos/{performerId}/{videoId}/content/{fileName}
/temp/{userId}/{sessionId}/{fileName} (6時間で自動削除)
```

### 3. Realtime Database セキュリティルール

#### リアルタイム機能：

- **プレゼンス管理**: オンライン状態の追跡
- **ライブチャット**: メッセージングシステム
- **ストリーミング状態**: ライブ配信の管理
- **リアルタイム統計**: 視聴者数、いいね数

## デプロイ手順

### 1. 環境変数の設定

```bash
export FIREBASE_PROJECT_ID="your-project-id"
```

### 2. ルールのデプロイ

```bash
# 本番環境へのデプロイ
./deploy-firebase-rules.sh production deploy

# ステージング環境へのデプロイ
./deploy-firebase-rules.sh staging deploy

# 開発環境へのデプロイ
./deploy-firebase-rules.sh development deploy
```

### 3. ロールバック（必要な場合）

```bash
# バックアップからのロールバック
./deploy-firebase-rules.sh production rollback backups/rules/[タイムスタンプ]
```

## セキュリティのベストプラクティス

### 1. 最小権限の原則

- ユーザーには必要最小限の権限のみを付与
- デフォルトですべてのアクセスを拒否

### 2. データ検証

- すべての書き込み操作でデータを検証
- 必須フィールドの確認
- データ型とフォーマットの検証

### 3. レート制限

- API乱用を防ぐための制限実装
- コレクション別の細かい制御

### 4. 監査ログ

- すべての重要な操作を記録
- システムのみが書き込み可能

## 管理者向け機能

### 権限レベル

1. **モデレーター**
   - KYC申請の確認と承認
   - コンテンツの監視

2. **管理者**
   - ユーザー管理
   - システム設定の変更
   - 統計情報の閲覧

3. **スーパー管理者**
   - すべての権限
   - 機密設定へのアクセス
   - バックアップの管理

## トラブルシューティング

### よくある問題

1. **権限エラー**
   - ユーザーのトークンを確認
   - カスタムクレームが正しく設定されているか確認

2. **レート制限エラー**
   - rateLimitsコレクションを確認
   - 必要に応じて制限を調整

3. **データ検証エラー**
   - 送信データの形式を確認
   - 必須フィールドがすべて含まれているか確認

## 監視とメンテナンス

### 定期的な確認事項

- [ ] セキュリティルールの使用状況
- [ ] レート制限の効果
- [ ] 異常なアクセスパターン
- [ ] ストレージ使用量

### アラート設定

Firebase コンソールで以下のアラートを設定：

1. セキュリティルール違反の急増
2. ストレージ使用量の急増
3. 異常なデータベース読み取り/書き込み

## 更新履歴

- 2025-01-16: 初版作成（本番環境向け最適化）