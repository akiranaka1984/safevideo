# Sharegram Error Code Reference

## エラーコード体系
Sharegramシステムでは、SHARE001からSHARE999までの統一されたエラーコード体系を使用しています。

## エラーレスポンス形式
```json
{
  "error": {
    "code": "SHARE001",
    "message": "APIキーが無効です",
    "statusCode": 401,
    "timestamp": "2024-06-30T10:00:00.000Z",
    "path": "/api/documents/by-external-id/123",
    "method": "GET",
    "details": {
      // 追加の詳細情報（オプション）
    }
  }
}
```

## エラーコード一覧

### 認証・認可関連 (SHARE001-SHARE099)
| コード | メッセージ | HTTPステータス | 説明 |
|--------|-----------|--------------|------|
| SHARE001 | APIキーが無効です | 401 | 提供されたAPIキーが存在しないか無効 |
| SHARE002 | APIキーの有効期限が切れています | 401 | APIキーの有効期限切れ |
| SHARE003 | 署名が無効です | 401 | HMAC署名の検証失敗 |
| SHARE004 | タイムスタンプが無効です | 401 | リクエストタイムスタンプが古いか無効 |
| SHARE005 | 必須ヘッダーが不足しています | 400 | 必須の認証ヘッダーが不足 |
| SHARE006 | APIクライアントが無効です | 401 | X-API-Clientヘッダーの値が無効 |
| SHARE007 | アクセス権限がありません | 403 | リソースへのアクセス権限なし |
| SHARE008 | レート制限を超えました | 429 | APIレート制限超過 |
| SHARE009 | 統合設定が無効です | 401 | Sharegram統合設定が無効または非アクティブ |
| SHARE010 | セッションの有効期限が切れています | 401 | セッションタイムアウト |

### データ検証関連 (SHARE100-SHARE199)
| コード | メッセージ | HTTPステータス | 説明 |
|--------|-----------|--------------|------|
| SHARE101 | リクエストデータが不正です | 400 | JSONパースエラーまたは不正な形式 |
| SHARE102 | 必須フィールドが不足しています | 400 | 必須パラメータの欠如 |
| SHARE103 | データ形式が無効です | 400 | フィールドの型や形式が不正 |
| SHARE104 | ファイルサイズが制限を超えています | 400 | アップロードファイルサイズ超過 |
| SHARE105 | 許可されていないファイル形式です | 400 | 非対応のファイル形式 |
| SHARE106 | external_idが重複しています | 409 | 既存のexternal_idとの重複 |
| SHARE107 | データの整合性エラーです | 422 | データ間の整合性違反 |

### パフォーマー関連 (SHARE200-SHARE299)
| コード | メッセージ | HTTPステータス | 説明 |
|--------|-----------|--------------|------|
| SHARE201 | パフォーマーが見つかりません | 404 | 指定されたパフォーマーが存在しない |
| SHARE202 | パフォーマー情報が不完全です | 422 | 必須情報の不足 |
| SHARE203 | KYC検証が未完了です | 422 | KYC検証プロセスが未完了 |
| SHARE204 | KYC検証の有効期限が切れています | 422 | KYC検証の再実施が必要 |
| SHARE205 | ドキュメントが見つかりません | 404 | 指定されたドキュメントが存在しない |
| SHARE206 | ドキュメントの検証に失敗しました | 422 | ドキュメント検証エラー |
| SHARE207 | パフォーマーのステータスが無効です | 422 | 無効なステータス値 |

### 同期処理関連 (SHARE300-SHARE399)
| コード | メッセージ | HTTPステータス | 説明 |
|--------|-----------|--------------|------|
| SHARE301 | 同期処理が失敗しました | 500 | 同期処理の全体的な失敗 |
| SHARE302 | 同期データが不正です | 400 | 同期用データの形式エラー |
| SHARE303 | バッチ処理が部分的に失敗しました | 207 | 一部のレコードの処理失敗 |
| SHARE304 | 同期がタイムアウトしました | 504 | 同期処理のタイムアウト |
| SHARE305 | 同期レート制限に達しました | 429 | 同期API呼び出しの制限超過 |

### Webhook関連 (SHARE400-SHARE499)
| コード | メッセージ | HTTPステータス | 説明 |
|--------|-----------|--------------|------|
| SHARE401 | Webhook配信に失敗しました | 500 | Webhook送信エラー |
| SHARE402 | Webhook署名が無効です | 401 | Webhook署名検証失敗 |
| SHARE403 | Webhookエンドポイントが無効です | 400 | 無効なWebhook URL |
| SHARE404 | Webhookイベントタイプが無効です | 400 | サポートされていないイベントタイプ |
| SHARE405 | Webhookペイロードが大きすぎます | 413 | ペイロードサイズ超過 |

### キャッシュ関連 (SHARE500-SHARE599)
| コード | メッセージ | HTTPステータス | 説明 |
|--------|-----------|--------------|------|
| SHARE501 | キャッシュエラーが発生しました | 500 | Redis等のキャッシュエラー |
| SHARE502 | キャッシュが利用できません | 503 | キャッシュサービス停止 |
| SHARE503 | キャッシュキーが無効です | 400 | 無効なキャッシュキー形式 |

### 外部サービス関連 (SHARE600-SHARE699)
| コード | メッセージ | HTTPステータス | 説明 |
|--------|-----------|--------------|------|
| SHARE601 | 外部APIの呼び出しに失敗しました | 502 | 外部API呼び出しエラー |
| SHARE602 | 外部サービスがタイムアウトしました | 504 | 外部サービスタイムアウト |
| SHARE603 | 外部サービスが利用できません | 503 | 外部サービス停止中 |

### システムエラー (SHARE900-SHARE999)
| コード | メッセージ | HTTPステータス | 説明 |
|--------|-----------|--------------|------|
| SHARE901 | データベースエラーが発生しました | 500 | DB接続/クエリエラー |
| SHARE902 | ファイルシステムエラーが発生しました | 500 | ファイル操作エラー |
| SHARE903 | メモリ不足エラーが発生しました | 500 | システムリソース不足 |
| SHARE904 | 設定エラーが発生しました | 500 | 環境変数/設定ファイルエラー |
| SHARE999 | 予期しないエラーが発生しました | 500 | その他の未分類エラー |

## 使用例

```javascript
const { createSharegramError } = require('../middleware/errorHandler');

// エラーをスロー
throw createSharegramError('SHARE001', { 
  apiKey: 'sk_xxx...',
  reason: 'Key not found in database'
});

// エラーレスポンス例
{
  "error": {
    "code": "SHARE001",
    "message": "APIキーが無効です",
    "statusCode": 401,
    "timestamp": "2024-06-30T10:00:00.000Z",
    "path": "/api/documents/by-external-id/123",
    "method": "GET",
    "details": {
      "apiKey": "sk_xxx...",
      "reason": "Key not found in database"
    }
  }
}
```

## エラーハンドリングベストプラクティス

1. **適切なエラーコードの選択**
   - 最も具体的で適切なエラーコードを使用
   - 不明な場合はSHARE999を使用

2. **詳細情報の提供**
   - detailsフィールドを活用して追加情報を提供
   - 開発環境ではスタックトレースを含める

3. **一貫性の維持**
   - 常に同じフォーマットでエラーを返す
   - HTTPステータスコードとエラーコードを適切に対応させる

4. **セキュリティの考慮**
   - 本番環境では内部情報を露出しない
   - エラーメッセージは一般的な内容に留める